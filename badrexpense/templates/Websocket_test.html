<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        button { padding: 8px 15px; margin: 5px; }
        input { padding: 8px; margin: 5px; width: 150px; }
        select { padding: 8px; margin: 5px; width: 150px; }
        pre { background-color: #f5f5f5; padding: 10px; border-radius: 5px; }
        .status { padding: 5px 10px; border-radius: 3px; display: inline-block; }
        .connected { background-color: #dff0d8; color: #3c763d; }
        .disconnected { background-color: #f2dede; color: #a94442; }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket Technician Tracker</h1>
        <div>
            <button id="connectBtn">Connect</button>
            <button id="disconnectBtn" disabled>Disconnect</button>
            <span>Status: </span>
            <span id="status" class="status disconnected">Disconnected</span>
        </div>
        
        <div style="margin-top: 20px;">
            <h3>Update Technician</h3>
            <div>
                <input type="number" id="techId" placeholder="Technician ID">
            </div>
            <div>
                <input type="text" id="latitude" placeholder="Latitude (e.g. 33.574)">
                <input type="text" id="longitude" placeholder="Longitude (e.g. -7.582)">
            </div>
            <div>
                <select id="status">
                    <option value="">-- Select Status --</option>
                    <option value="available">Available</option>
                    <option value="off_duty">Off Duty</option>
                    <option value="on_mission">On Mission</option>
                </select>
                <button id="sendBtn" disabled>Update Technician</button>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <h3>Messages:</h3>
            <pre id="messages"></pre>
        </div>
    </div>

    <script>
        let socket = null;
        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const sendBtn = document.getElementById('sendBtn');
        
        function appendMessage(message) {
            const timestamp = new Date().toLocaleTimeString();
            messagesEl.textContent = `[${timestamp}] ${message}\n` + messagesEl.textContent;
        }
        
        function updateStatus(status) {
            statusEl.textContent = status;
            statusEl.className = 'status ' + (status === 'Connected' ? 'connected' : 'disconnected');
        }
        
        
        // Connect button
        connectBtn.addEventListener('click', () => {
            // Use the correct WebSocket URL that matches your routing configuration
            socket = new WebSocket('ws://192.168.90.74:8000/ws/technician/');
            
            socket.onopen = function(e) {
                updateStatus('Connected');
                appendMessage('Connection established');
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendBtn.disabled = false;
                
                // Send initial status request
                socket.send(JSON.stringify({ type: 'status_request' }));
            };
            
            socket.onmessage = function(e) {
                try {
                    const data = JSON.parse(e.data);
                    
                    if (data.type === 'error') {
                        appendMessage('ERROR: ' + data.message);
                    } else {
                        appendMessage('Received: ' + JSON.stringify(data, null, 2));
                    }
                } catch (err) {
                    appendMessage('Error parsing message: ' + err);
                }
            };
            
            socket.onclose = function(e) {
                updateStatus('Disconnected');
                appendMessage(`Connection closed (code: ${e.code})`);
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendBtn.disabled = true;
            };
            
            socket.onerror = function(e) {
                updateStatus('Error');
                appendMessage('WebSocket Error!');
                console.error('WebSocket error:', e);
            };
        });
        
        // Disconnect button
        disconnectBtn.addEventListener('click', () => {
            if (socket) {
                socket.close();
            }
        });
        
        // Send button
        sendBtn.addEventListener('click', () => {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const techId = document.getElementById('techId').value;
                const latitude = document.getElementById('latitude').value;
                const longitude = document.getElementById('longitude').value;
                const status = document.getElementById('status').value;
                
                if (!techId) {
                    appendMessage('Error: Technician ID is required');
                    return;
                }
                
                const message = {
                    type: 'update_location',
                    id: parseInt(techId),
                    // Only include fields that have values
                    ...(latitude ? { latitude: parseFloat(latitude) } : {}),
                    ...(longitude ? { longitude: parseFloat(longitude) } : {}),
                    ...(status ? { status: status } : {})
                };
                
                socket.send(JSON.stringify(message));
                appendMessage('Sent: ' + JSON.stringify(message, null, 2));
            }
        });
    </script>
</body>
</html>